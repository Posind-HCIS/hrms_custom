# ==========================================
# SonarCloud - Analisis Kualitas Kode
# ==========================================
# Workflow ini otomatis mengecek:
# - Kualitas kode (bugs, vulnerabilities, code smells)
# - Code coverage dari unit tests
# - Code style dengan linter
# ==========================================

name: SonarCloud Analysis

on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

# Hindari workflow duplikat berjalan bersamaan
concurrency:
  group: sonarcloud-${{ github.event_name }}-${{ github.event.number || github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: Analisis Kualitas Kode
    runs-on: ubuntu-latest
    
    steps:
      # ========================================
      # 1. PERSIAPAN
      # ========================================
      
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history untuk analisis yang lebih akurat

      - name: Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          pip install coverage pytest pytest-cov ruff

      # ========================================
      # 2. CODE LINTING
      # ========================================
      
      - name: Jalankan Ruff Linter
        run: |
          echo "ðŸ” Mengecek code style dengan Ruff..."
          ruff check hrms_custom/ || echo "âš ï¸ Linter menemukan issues"
        continue-on-error: true

      # ========================================
      # 3. TESTING & COVERAGE
      # ========================================
      
      - name: Run Tests dengan Coverage
        run: |
          echo "ðŸ§ª Menjalankan unit tests..."
          pytest --cov=hrms_custom \
                 --cov-report=xml:coverage.xml \
                 --cov-report=term-missing || echo "âš ï¸ Beberapa test gagal"
        continue-on-error: true

      - name: Perbaiki Path Coverage Report
        if: hashFiles('coverage.xml') != ''
        run: |
          sed -i 's|/home/runner/work/hrms_custom/hrms_custom|/github/workspace|g' coverage.xml

      # ========================================
      # 4. SONARCLOUD ANALYSIS
      # ========================================
      
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@v2.3.0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: false
        with:
          args: >
            -Dsonar.projectKey=Posind-HCIS_hrms_custom
            -Dsonar.organization=posind-hcis
            -Dsonar.python.coverage.reportPaths=coverage.xml
            -Dsonar.sources=hrms_custom
            -Dsonar.python.version=3.11
            -Dsonar.exclusions=**/__pycache__/**,**/*.pyc,**/node_modules/**,**/migrations/**,**/.git/**,**/public/**,**/dist/**,**/tests/**,**/test_*.py
            -Dsonar.scm.provider=git

      - name: Cek Quality Gate
        uses: sonarsource/sonarqube-quality-gate-action@v1.1.0
        timeout-minutes: 5
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        continue-on-error: true

      # ========================================
      # 5. SIMPAN HASIL
      # ========================================
      
      - name: Upload Coverage Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: coverage.xml
          retention-days: 7
        continue-on-error: true
